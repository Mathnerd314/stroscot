<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Objects &mdash; Stroscot  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/hexagon_favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Package manager" href="PackageManager.html" />
    <link rel="prev" title="Modules" href="Modules.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html">
            <img src="../_static/hexagon_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../GettingStarted/index.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HowTo/index.html">How to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/index.html">Language Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Commentary</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Assembly.html">Assembly</a></li>
<li class="toctree-l2"><a class="reference internal" href="BuildSystem.html">Build system</a></li>
<li class="toctree-l2"><a class="reference internal" href="Checklist.html">Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="Code-Generation.html">Code generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Compiler.html">Compiler design</a></li>
<li class="toctree-l2"><a class="reference internal" href="CompilerOutput.html">Compiler output</a></li>
<li class="toctree-l2"><a class="reference internal" href="Concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="CoreSyntax.html">Core syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="Dispatch.html">Dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="Evaluation-Strategy.html">Evaluation strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="Exceptions.html">Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="Fastest.html">As fast as C</a></li>
<li class="toctree-l2"><a class="reference internal" href="IR.html">Control flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="IR.html#blocks">Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="IR.html#id1">Blocks</a></li>
<li class="toctree-l2"><a class="reference internal" href="IR.html#ir-style">IR Style</a></li>
<li class="toctree-l2"><a class="reference internal" href="Intrinsics.html">Intrinsics</a></li>
<li class="toctree-l2"><a class="reference internal" href="Library.html">Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="Logic.html">Logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="LogicProgramming.html">Logic programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="Macros.html">Macros</a></li>
<li class="toctree-l2"><a class="reference internal" href="Memory-Management.html">Memory management</a></li>
<li class="toctree-l2"><a class="reference internal" href="Meta.html">Meta</a></li>
<li class="toctree-l2"><a class="reference internal" href="Modules.html">Modules</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#minimal-oo">Minimal OO</a></li>
<li class="toctree-l3"><a class="reference internal" href="#serialization">Serialization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cycles-and-non-serializable-data">Cycles and non-serializable data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#all-or-nothing-field-access">All-or-nothing field access</a></li>
<li class="toctree-l3"><a class="reference internal" href="#no-inheritance">No inheritance</a></li>
<li class="toctree-l3"><a class="reference internal" href="#no-constructors">No constructors</a></li>
<li class="toctree-l3"><a class="reference internal" href="#no-traits-or-methods">No traits or methods</a></li>
<li class="toctree-l3"><a class="reference internal" href="#no-autoboxing">No autoboxing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#no-object-identity">No object identity</a></li>
<li class="toctree-l3"><a class="reference internal" href="#no-implicit-synchronization-lock">No implicit synchronization lock</a></li>
<li class="toctree-l3"><a class="reference internal" href="#emulating-typical-oo">Emulating typical OO</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#emulating-inheritance">Emulating inheritance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vtables">vtables</a></li>
<li class="toctree-l4"><a class="reference internal" href="#headers">Headers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="PackageManager.html">Package manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="Posets.html">Posets</a></li>
<li class="toctree-l2"><a class="reference internal" href="Programs.html">Exemplary programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="Reduction.html">Reduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="Reduction-Example.html">Reduction example</a></li>
<li class="toctree-l2"><a class="reference internal" href="Resource-Management.html">Resource management</a></li>
<li class="toctree-l2"><a class="reference internal" href="Sets.html">Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="State.html">Stateful programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="Syntax.html">Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="TermRewriting.html">Term rewriting</a></li>
<li class="toctree-l2"><a class="reference internal" href="Time.html">Time API</a></li>
<li class="toctree-l2"><a class="reference internal" href="Types.html">Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="Units.html">Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="Verification.html">Verification</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../zzreferences.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Stroscot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Commentary</a></li>
      <li class="breadcrumb-item active">Objects</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/Mathnerd314/stroscot/edit/master/docs/Commentary/Objects.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="objects">
<h1>Objects<a class="headerlink" href="#objects" title="Permalink to this heading"></a></h1>
<p>Many people like to use the phrase “object-oriented”. As far as I can tell this has no standard meaning - OO can refer to any of many concepts, principles, techniques, patterns, and philosophies used in software development. So for that reason the phrase is not used in the rest of the documentation. But as discussed here, by Bob’s minimal definition, Stroscot is OO. Still compared to other “OO” languages it leaves out many “OO” features.</p>
<section id="minimal-oo">
<h2>Minimal OO<a class="headerlink" href="#minimal-oo" title="Permalink to this heading"></a></h2>
<p>Uncle Bob <a class="reference external" href="https://blog.cleancoder.com/uncle-bob/2018/04/13/FPvsOO.html">defines</a> OO by distinguishing <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">o</span></code> from <code class="docutils literal notranslate"><span class="pre">o.f()</span></code>. With Uniform Function Call Syntax there is no difference. But, he argues, in an OO language <code class="docutils literal notranslate"><span class="pre">o.f()</span></code> is overloaded - it does dynamic dispatch based on the type of <code class="docutils literal notranslate"><span class="pre">o</span></code>. Whereas with <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">o</span></code> there is usually only one group of clauses for <code class="docutils literal notranslate"><span class="pre">f</span></code>. Bob also wants to exclude implementations of dynamic dispatch that work by modifying <code class="docutils literal notranslate"><span class="pre">f</span></code> to use switch statements or long if/else chains. So he excludes dynamic dispatch that creates a source code dependency from <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">o</span></code> to <code class="docutils literal notranslate"><span class="pre">f</span></code>, i.e. <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">o</span></code> “knows” <code class="docutils literal notranslate"><span class="pre">f</span></code>. Instead there must be several clauses for <code class="docutils literal notranslate"><span class="pre">f</span></code> which may be called. Concretely, Bob says, one should be able to write <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">o</span></code> in source file A and an implementation of <code class="docutils literal notranslate"><span class="pre">f</span></code> in source file B and there should be no use/require/import declaration from A to B.</p>
<p>Stroscot has predicate dispatch and multimethods. So all functions can be overloaded and do dynamic dispatch. Stroscot solves the expression problem, so there is no boilerplate needed when extending <code class="docutils literal notranslate"><span class="pre">f</span></code>. Furthermore, Stroscot uses a recursive knot so definitions are properly in scope. So Stroscot is OO in Bob’s minimalist sense.</p>
</section>
<section id="serialization">
<h2>Serialization<a class="headerlink" href="#serialization" title="Permalink to this heading"></a></h2>
<p>Serialization is the ability to convert an object graph into a stream of bytes, and more broadly the reverse as well (deserialization). Serialization interacts with nearly everything; it is a critical facility. In Java the OO model was defined first and serialization was added later as a “magic function”. The design has various problems, as described in <a class="reference external" href="https://openjdk.org/projects/amber/design-notes/towards-better-serialization">Project Amber</a>:</p>
<ul class="simple">
<li><p>serialization can access private classes and fields, an implicit public set of accessors</p></li>
<li><p>deserialization bypasses defined constructors and directly creates objects via the runtime, an implicit public constructor</p></li>
<li><p>serialization/deserialization uses magic private methods and fields to guide the process, such as readObject, writeObject, readObjectNoData, readResolve, writeReplace, serialVersionUID, and serialPersistentFields</p></li>
<li><p>The Serializable marker interface doesn’t actually mean that instances are serializable. Objects may throw during serialization, as e.g. Java has no way to express the constraint that a TreeMap is serializable only if the Comparator passed to the constructor is serializable. Also there are objects such as lambdas, which are easily serializable but error due to lacking Serializable, requiring special type casts.</p></li>
<li><p>Serialization uses a fixed encoding format that cannot be modified to JSON/XML/a more efficient/flexible format, or one with version markers. There are no checks that serialization/deserialization is a round trip.</p></li>
</ul>
<p>Serial form: a logical at-rest state that can be written to a stream or stored in memory. This state should be orthogonal to the choice of bytestream encoding. Java serialization strongly encourages using an object’s in-memory state as its serial form. Sometimes this is a sensible choice, but sometimes this is a terrible choice, and overriding this choice currently involves using a difficult and error-prone mechanism (readObject and writeObject.)</p>
<p>State extraction/reconstruction. Java serialization uses reflection to extract/set the non-transient fields of an object, using its privileged status to access otherwise inaccessible fields.</p>
<p>Versioning. Classes evolve over time. Unless you plan for versioning from the beginning, it can be very difficult to version the serialized form with the tools available without sacrificing compatibility. Serialization should force implementations to confront past (and possibly future) versions of their serial form, and make clear which old versions a class agrees to or refuses to deserialize, and how they map to the current representation. It should be easy and explicit to mediate between different versions of serial form and live object state.</p>
<p>Stream format/wire encoding. The choice of stream format is probably the least interesting part of a serialization mechanism; once a suitable serial form is chosen, it can be encoded with any number of encodings.</p>
<p>Project Amber proposes to restrict serialization to using public object facilities, so that the serialization functions for each type could be written piecemeal as external library functions. But universal serialization is important, so Stroscot goes further: we restrict the object model to objects that can be serialized easily, so that serialization functions are simply generic functions and aren’t written individually for each type. This makes a large part of the serialization weirdness just vanish. Of course you can always define specialized serialization behaviors on top of the generic facility.</p>
<p>persist data, or to exchange data with other applications. Not objects; data.</p>
<section id="cycles-and-non-serializable-data">
<h3>Cycles and non-serializable data<a class="headerlink" href="#cycles-and-non-serializable-data" title="Permalink to this heading"></a></h3>
<p>Cyclic data occurs in many places, e.g. a doubly linked list <code class="docutils literal notranslate"><span class="pre">rec</span> <span class="pre">{</span> <span class="pre">a</span> <span class="pre">=</span> <span class="pre">{next:</span> <span class="pre">b,</span> <span class="pre">prev:</span> <span class="pre">None};</span> <span class="pre">b</span> <span class="pre">=</span> <span class="pre">{next:</span> <span class="pre">None,</span> <span class="pre">prev:</span> <span class="pre">a}</span> <span class="pre">}</span></code>. We also have non-serializable data such as finalizers that does not live across program restarts. These cannot be serialized to JSON etc. as-is, because the format doesn’t support it. The solution is a replacer, which transforms cyclic and non-serializable data to a form suitable for serialization. The replacer produces a bijection from bad values to good values, so that we can serialize the good values in place of the bad values and do the opposite transformation on deserialization. Then we serialize this bijection separately (out-of-band).</p>
<p>It is much easier to do replacement out of band because in-band replacement leads to DOS attacks such as “billion laughs”. Basically the attacker defines a system such as <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">&quot;lol&quot;;</span> <span class="pre">b</span> <span class="pre">=</span> <span class="pre">a+a;</span> <span class="pre">c=b+b;</span> <span class="pre">d=c+c;</span></code>, etc., constructing a string of a billion laughs, or similarly a large object that takes up too much memory. A simple solution is to cap memory usage, but this means some objects fail to serialize. Instead in-band entities must be treated lazily and not expanded unless necessary. Out-of-band avoids the issue by not allowing references in data.</p>
</section>
</section>
<section id="all-or-nothing-field-access">
<h2>All-or-nothing field access<a class="headerlink" href="#all-or-nothing-field-access" title="Permalink to this heading"></a></h2>
<p>In Stroscot, if you can access the term’s constructor symbol, you have full data access to all fields and can destruct and create values with that constructor. But, you can avoid exporting a constructor symbol from a module - that means a user will have to use the defined factory functions and accessors, or else deliberately import the <code class="docutils literal notranslate"><span class="pre">._internal</span></code> module.</p>
<p>Similarly all fields are final - mutations are made by creating a new value. But if the field’s value is a reference then you can mutate the reference as much as you want. You can just read the value if you don’t want it to change, this is what Java calls “defensive copying”.</p>
</section>
<section id="no-inheritance">
<span id="id1"></span><h2>No inheritance<a class="headerlink" href="#no-inheritance" title="Permalink to this heading"></a></h2>
<p>Overriding a method only works when you know what is calling the function and its context and invariants. It defines an interface rather than a behavior. Languages have addressed this with explicit interface types, so that a value may satisfy many interface specifications. But interfaces are simply type specifiers and do not incorporate the complexities of inheritance. There is no inheritance relationship betwen interfaces - an interface extends another by including the methods of the other interface. In general one doesn’t need an explicit type hierarchy at all. Types just are, they don’t have to announce their relationships. The relationships between types such as subset and superset can be inferred on demand.</p>
<p>For inheritance as subtyping, inheritance isn’t even compatible with the <a class="reference external" href="https://en.wikipedia.org/wiki/Liskov_substitution_principle">Liskov substitution principle</a>. Supposing <code class="docutils literal notranslate"><span class="pre">A</span> <span class="pre">extends</span> <span class="pre">B</span></code>, the predicate <code class="docutils literal notranslate"><span class="pre">\x</span> <span class="pre">-&gt;</span> <span class="pre">not</span> <span class="pre">(x</span> <span class="pre">instanceof</span> <span class="pre">A)</span></code> is satisfied by <code class="docutils literal notranslate"><span class="pre">B</span></code> but not by <code class="docutils literal notranslate"><span class="pre">A</span></code>. So by LSP, A is not substitutable for B. If this is too abstract, consider <code class="docutils literal notranslate"><span class="pre">Circle</span> <span class="pre">extends</span> <span class="pre">Ellipse</span></code>, <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">Ellipse</span> <span class="pre">{</span> <span class="pre">final</span> <span class="pre">float</span> <span class="pre">x,</span> <span class="pre">y;</span> <span class="pre">}</span></code>. We must make the class immutable, otherwise one could make a circle non-circular. But even this is not enough, because <code class="docutils literal notranslate"><span class="pre">Ellipse</span> <span class="pre">{</span> <span class="pre">x</span> <span class="pre">=</span> <span class="pre">1,</span> <span class="pre">y</span> <span class="pre">=</span> <span class="pre">1</span> <span class="pre">}</span></code> is a circle but is not a member of the Circle class. The only solution is to forbid this value somehow, e.g. requiring to construct the objects using a factory function. A more natural solution is avoid inheritance and instead declare Circle as a refinement type of Ellipse, <code class="docutils literal notranslate"><span class="pre">Circle</span> <span class="pre">=</span> <span class="pre">{</span> <span class="pre">e</span> <span class="pre">:</span> <span class="pre">Ellipse</span> <span class="pre">|</span> <span class="pre">e.x</span> <span class="pre">==</span> <span class="pre">e.y</span> <span class="pre">}</span></code>. Then an ellipse with equal components is automatically a circle. Similarly with serialization, a class <code class="docutils literal notranslate"><span class="pre">A</span></code> may be serializable but a class <code class="docutils literal notranslate"><span class="pre">B</span> <span class="pre">extends</span> <span class="pre">A</span> <span class="pre">{</span> <span class="pre">Unserializable</span> <span class="pre">f;</span> <span class="pre">}</span></code> will not be.</p>
<p>Composition can replace inheritance in at least 22% of cases <span id="id2">[<a class="reference internal" href="../zzreferences.html#id146" title="Ewan Tempero, Hong Yul Yang, and James Noble. What Programmers Do with Inheritance in Java. In David Hutchison, Takeo Kanade, Josef Kittler, Jon M. Kleinberg, Friedemann Mattern, John C. Mitchell, Moni Naor, Oscar Nierstrasz, C. Pandu Rangan, Bernhard Steffen, Madhu Sudan, Demetri Terzopoulos, Doug Tygar, Moshe Y. Vardi, Gerhard Weikum, and Giuseppe Castagna, editors, ECOOP 2013 – Object-Oriented Programming, volume 7920, pages 577–601. Springer Berlin Heidelberg, Berlin, Heidelberg, 2013. URL: http://link.springer.com/10.1007/978-3-642-39038-8_24 (visited on 2022-08-31), doi:10.1007/978-3-642-39038-8_24.">TYN13</a>]</span> - just include the “parent” as a field. This offers better encapsulation and <a class="reference external" href="https://en.wikipedia.org/wiki/Composition_over_inheritance">composition over inheritance</a> has been recommended as an OO best practice.  Consider a list with <code class="docutils literal notranslate"><span class="pre">add</span></code> and <code class="docutils literal notranslate"><span class="pre">addAll</span></code> methods. Suppose you want a “counting list” that tracks the total number of objects added (the length plus the number of objects removed). With composition you can count what’s passed to <code class="docutils literal notranslate"><span class="pre">addAll</span></code> and <code class="docutils literal notranslate"><span class="pre">add</span></code> and update a counter, and all works well. With inheritance, and the counting list as a subclass, it doesn’t work as expected because the list’s <code class="docutils literal notranslate"><span class="pre">addAll</span></code> method calls the subclass’s <code class="docutils literal notranslate"><span class="pre">add</span></code>, and the added objects are double counted.</p>
<p>One pain point when using composition to replace inheritance is that there are lots of boilerplate forwarding functions that simply pass through to the parent. But even traditional OO languages are full of these boilerplate wrappers. So this is not really a problem so much as an opportunity. Scala has <a class="reference external" href="https://docs.scala-lang.org/scala3/reference/other-new-features/export.html">export clauses</a>. But Julia’s solution of macros such as <a class="reference external" href="https://github.com/JeffreySarnoff/TypedDelegation.jl">TypedDelegation.jl</a> seems more appropriate, something like <code class="docutils literal notranslate"><span class="pre">forward</span> <span class="pre">CountingList</span> <span class="pre">to</span> <span class="pre">list</span> <span class="pre">for</span> <span class="pre">List</span></code> which expands to lots of declarations like <code class="docutils literal notranslate"><span class="pre">delete</span> <span class="pre">a</span> <span class="pre">(x</span> <span class="pre">:</span> <span class="pre">CountingList)</span> <span class="pre">=</span> <span class="pre">x</span> <span class="pre">{</span> <span class="pre">list</span> <span class="pre">=</span> <span class="pre">delete</span> <span class="pre">a</span> <span class="pre">x.list</span> <span class="pre">}</span></code>. It has to read all symbols from the List module, look up the types, filter to the ones using the List type that have not already been redefined, then write out a new clause that applies the wrapper based on the type. Another option is to write a catch-all handler that traps accessing methods or properties and redirects to the field, but using the built-in dispatch like with the macro is more straightforward.</p>
</section>
<section id="no-constructors">
<h2>No constructors<a class="headerlink" href="#no-constructors" title="Permalink to this heading"></a></h2>
<p>A constructor is a special type of subroutine that produces an object and returns it. Meanwhile a factory function is an ordinary function that produces an object and returns it. What is the difference? Mainly the limitations: a constructor must allocate new memory, it cannot return a subclass, and it has to be called with a noisy “new” syntax and a fixed name. Factory functions have none of these limitations.</p>
<p>For example, a factory function can memoize common values. A boxed primitive boolean should only have two values. But a constructor forces the program to produce millions of distinct trues and falses, creating significant overhead. A factory function can construct one true and one false and then return those from then on, avoiding the overhead entirely.</p>
<p>Another difference is that a factory function computes the field values first and then (typically) allocates and initializes memory, while a constructor allocates memory initialized to a default value and then overwrites each field. This implicit memory write means that concurrency and constructors interact poorly. With factory functions using an allocate-and-initialize primitive, the memory is treated as immutable, so the only issue is ensuring the allocation is private.</p>
<p>Deserialization bypasses defined constructors and directly creates objects via the runtime - it is an implicit public constructor. In fact this deserialization constructor is exactly the allocate-and-initialize primitive that a factory function needs.</p>
<p>One use of constructors is to enforce invariants (validity checking); for example a time constructor that ensures <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">&lt;=</span> <span class="pre">minutes</span> <span class="pre">&lt;</span> <span class="pre">60</span></code>. In Stroscot, invariants like these are defined in types, and checked on use, rather than on construction. It is often very helpful to be able to talk about about unnormalized data, which the constructor pattern prevents. And when you need the invariants, the types establish object integrity. Whereas in Java you must reason about all mutating methods to identify the possible states of an object, in Stroscot only the type needs to be examined.</p>
<p>A minor downside of doing away with constructors is that factory functions are not automatically marked in the documentation, so can be harder to find. Organizing the source code and documentation to group factory methods is not hard, the hard part is enforcing that such a convention is followed consistently. But it’s not even clear that grouping factory functions together is the best organization.</p>
</section>
<section id="no-traits-or-methods">
<h2>No traits or methods<a class="headerlink" href="#no-traits-or-methods" title="Permalink to this heading"></a></h2>
<p>Traits (Scala/Rust terminology, also called Java/Idris interfaces, Haskell typeclasses, etc.) are collections of methods. They are a morass of complexity. The trait could declare one, two, three, four functions or more. Already, there’s an issue. It’s not particularly clear how to structure that. How many traits do you have? Do you have one trait per function or one trait with all the functions and leave some functions unimplemented? There’s no clear guidance. Without traits, each function is its own complete unit and there is no decision to make - you write exactly the functions you need.</p>
<p>Suppose you fudged that out, and defined an trait that you think represents a good set of functions. Now, you have to implement the trait. In Java you need to inherit the trait. In Haskell you have to implement a typeclass. In both cases a big problem comes up: you can only implement the trait once for a given type. There are ways to work around this. Java has the adapter pattern to create a record of functions, and similarly Idris allows <a class="reference external" href="https://docs.idris-lang.org/en/latest/tutorial/interfaces.html#named-implementations">named implementations</a>. But it’s a big mess. Sets and maps need a comparison operator. With multiple implementations floating around the comparisons can become inconsistent, e.g. inserting with comparison A and removing with comparison B.</p>
<p>Without traits, the functions get passed as implicit parameters, so there is no syntax needed for the default case. Multiple implementations can be accomplished using keyword parameter assignment. And to avoid inconsistent comparisons the map or set can store the comparison operator as a parameter on creation - it is simply a function after all.</p>
<p>As a corollary of this, Stroscot has no methods defined “inside” a type - you write <code class="docutils literal notranslate"><span class="pre">type</span> <span class="pre">=</span> <span class="pre">...;</span> <span class="pre">method</span> <span class="pre">=</span> <span class="pre">...</span></code> rather than <code class="docutils literal notranslate"><span class="pre">type</span> <span class="pre">=</span> <span class="pre">{</span> <span class="pre">...;</span> <span class="pre">method</span> <span class="pre">;</span> <span class="pre">...</span> <span class="pre">}</span></code>. They are all “free functions” or “extension methods”.</p>
</section>
<section id="no-autoboxing">
<h2>No autoboxing<a class="headerlink" href="#no-autoboxing" title="Permalink to this heading"></a></h2>
<p>Smalltalk had this idea that everything should be an object, including boolean and integer values. However, “wrapped primitive” objects like Boolean or Integer are distinct from normal OOP objects, in that when properly implemented they are immutable final singletons constructed through a factory method, in other words “value types”. Caching all of these immutable singleton objects is of course quite inefficient in terms of memory.</p>
<p>Many languages have implemented “wrapped primitives” as a leaky abstraction. For example in Java <code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">Integer(0)</span> <span class="pre">!=</span> <span class="pre">new</span> <span class="pre">Integer(0)</span></code>, but <code class="docutils literal notranslate"><span class="pre">Integer.valueOf(0)</span> <span class="pre">==</span> <span class="pre">Integer.valueOf(0)</span></code>. In JS <code class="docutils literal notranslate"><span class="pre">false</span></code> is of course false but <code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">Boolean(false)</span></code> is truthy.</p>
<p>Ultimately, discarding OO entirely and simply representing values as values is the most logical. Numbers are a distinct type of atomic value with a special meaning, and that’s okay. The idea that “everything should be an object” is mistaken and doesn’t actually simplify anything in practice. It’s better to say “everything is a value” and make reference values explicit like with <code class="docutils literal notranslate"><span class="pre">ref</span> <span class="pre">false</span></code>.</p>
<p>This is simpler than Java’s, because we lack:</p>
</section>
<section id="no-object-identity">
<h2>No object identity<a class="headerlink" href="#no-object-identity" title="Permalink to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">A()</span> <span class="pre">==</span> <span class="pre">new</span> <span class="pre">A()</span></code>. Java has this convoluted explanation of why it should be false and it just confuses people. Furthermore JSON cannot even represent the notion of object identity.</p>
</section>
<section id="no-implicit-synchronization-lock">
<h2>No implicit synchronization lock<a class="headerlink" href="#no-implicit-synchronization-lock" title="Permalink to this heading"></a></h2>
<p>If you want a mutex you have to create a value of the Mutex type, not just write <code class="docutils literal notranslate"><span class="pre">synchronize</span> <span class="pre">(random_object)</span></code>.</p>
<ul class="simple">
<li><p>resurrection via finalizers</p></li>
</ul>
</section>
<section id="emulating-typical-oo">
<h2>Emulating typical OO<a class="headerlink" href="#emulating-typical-oo" title="Permalink to this heading"></a></h2>
<p>Let’s suppose you are unconvinced by the arguments above, and want classes regardless. E.g. you are translating this Java program:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">class</span><span class="w"> </span><span class="kt">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">public</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="n">public</span><span class="w"> </span><span class="kt">Foo</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">b</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">public</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="n">getFoo</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>It is not too hard to emulate objects using a reference cell. It stores a tag to allow dynamic dispatch, and the tag is attached to a record that stores the state of the object. So you’d write something like:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">newFoo</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"></span>
<span class="w">  </span><span class="n">oid</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">mut</span><span class="w"> </span><span class="n">undefined</span><span class="w"></span>
<span class="w">  </span><span class="n">oid</span><span class="w"> </span><span class="kt">:=</span><span class="w"> </span><span class="kt">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="kt">:</span><span class="w"> </span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">return</span><span class="w"> </span><span class="n">oid</span><span class="w"></span>

<span class="nf">oid</span><span class="o">@</span><span class="p">(</span><span class="n">read</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="p">})</span><span class="o">.</span><span class="n">getFoo</span><span class="p">(</span><span class="n">arg</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"></span>
<span class="w">  </span><span class="n">x</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">arg</span><span class="w"></span>
<span class="w">  </span><span class="n">oid</span><span class="w"> </span><span class="kt">:=</span><span class="w"> </span><span class="kt">Foo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="w"></span>
</pre></div>
</div>
<section id="emulating-inheritance">
<h3>Emulating inheritance<a class="headerlink" href="#emulating-inheritance" title="Permalink to this heading"></a></h3>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">class</span><span class="w"> </span><span class="kt">A</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">String</span><span class="w"> </span><span class="n">s</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">Int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">A</span><span class="p">(</span><span class="kt">String</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">(</span><span class="n">s</span><span class="p">),</span><span class="w"> </span><span class="n">i</span><span class="p">(</span><span class="n">i</span><span class="p">){</span><span class="w"> </span><span class="n">constructor_A</span><span class="nb">()</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">virtual</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="kt">Display</span><span class="nb">()</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;A %s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">.</span><span class="n">c_str</span><span class="nb">()</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">virtual</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="kt">Reuse</span><span class="nb">()</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">return</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>


<span class="kr">class</span><span class="w"> </span><span class="kt">B:</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="kt">A</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">Char</span><span class="w"> </span><span class="n">c</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">B</span><span class="p">(</span><span class="kt">String</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="kt">Char</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">A</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="n">c</span><span class="p">(</span><span class="n">c</span><span class="p">){</span><span class="w"> </span><span class="n">constructor_B</span><span class="nb">()</span><span class="p">;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="c1">-- overrides the base class version</span><span class="w"></span>
<span class="w">    </span><span class="n">virtual</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="kt">Display</span><span class="nb">()</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;B %s %d %c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="o">.</span><span class="n">c_str</span><span class="nb">()</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">virtual</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="kt">Extra</span><span class="nb">()</span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;B Extra %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="kt">Reuse</span><span class="nb">()</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>Inheritance involves creating cases for each inherited method that wrap the reference to look like a superclass reference and call the superclass method. Here we have simply put the superclass in a reference:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">constructA</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">mut</span><span class="w"> </span><span class="p">(</span><span class="kt">A</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">i</span><span class="p">);</span><span class="w"> </span><span class="n">constructor_A</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="nf">display</span><span class="w"> </span><span class="p">(</span><span class="n">read</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">A</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">printf</span><span class="w"> </span><span class="s">&quot;A %s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="nf">reuse</span><span class="w"> </span><span class="p">(</span><span class="n">read</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">A</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="w"></span>

<span class="nf">constructB</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Char</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"></span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">constructA</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">i</span><span class="w"></span>
<span class="w">  </span><span class="n">r</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">mut</span><span class="w"> </span><span class="p">(</span><span class="kt">B</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"></span>
<span class="w">  </span><span class="n">constructor_B</span><span class="w"> </span><span class="n">r</span><span class="w"></span>

<span class="nf">extra</span><span class="w"> </span><span class="n">b</span><span class="o">@</span><span class="p">(</span><span class="n">read</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">B</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">putStrLn</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="s">&quot;B Extra &quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">show</span><span class="w"> </span><span class="p">(</span><span class="n">reuse</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"></span>
<span class="c1">-- overloads but does not override base class</span><span class="w"></span>
<span class="nf">display</span><span class="w"> </span><span class="n">b</span><span class="o">@</span><span class="p">(</span><span class="n">read</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">B</span><span class="w"> </span><span class="n">a</span><span class="o">@</span><span class="p">(</span><span class="n">read</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">A</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">printf</span><span class="w"> </span><span class="s">&quot;B %s %d %c&quot;</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">c</span><span class="w"></span>
<span class="c1">-- reuse delegates to A</span><span class="w"></span>
<span class="nf">reuse</span><span class="w"> </span><span class="n">b</span><span class="o">@</span><span class="p">(</span><span class="n">read</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">B</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">reuse</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
</pre></div>
</div>
<p>The more general approach is to make the derived class have all the fields from the class and all superclasses, and call superclass methods by passing a wrapper:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">convertToA</span><span class="w"> </span><span class="n">b</span><span class="o">@</span><span class="p">(</span><span class="n">read</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">B</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">newWrapper</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">read</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">A</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">read</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="n">read</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">i</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="n">modify</span><span class="w"> </span><span class="p">(</span><span class="kt">A</span><span class="w"> </span><span class="n">newS</span><span class="w"> </span><span class="n">newI</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"></span>
<span class="w">    </span><span class="n">old</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">read</span><span class="w"> </span><span class="n">b</span><span class="w"></span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="kt">:=</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">newS</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">newI</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="nf">reuse</span><span class="w"> </span><span class="n">b</span><span class="o">@</span><span class="p">(</span><span class="n">read</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">B</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">reuse</span><span class="w"> </span><span class="p">(</span><span class="n">convertToA</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="vtables">
<h3>vtables<a class="headerlink" href="#vtables" title="Permalink to this heading"></a></h3>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">class</span><span class="w"> </span><span class="kt">Base</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">public</span><span class="kt">:</span><span class="w"></span>
<span class="w">        </span><span class="n">virtual</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="n">method</span><span class="nb">()</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="kr">class</span><span class="w"> </span><span class="kt">Derived:</span><span class="w"> </span><span class="n">public</span><span class="w"> </span><span class="kt">Base</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">public</span><span class="kt">:</span><span class="w"></span>
<span class="w">        </span><span class="n">void</span><span class="w"> </span><span class="n">method</span><span class="nb">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>If you really want to match OO languages perfectly you can construct the vtables.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">vtable</span><span class="w"> </span><span class="kt">Derived</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Derived_method</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="nf">object</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">vtable</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">vtable</span><span class="w"> </span><span class="kt">Derived</span><span class="p">,</span><span class="w"> </span><span class="n">props</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="nf">vinvoke</span><span class="w"> </span><span class="s">&quot;method&quot;</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">object</span><span class="o">.</span><span class="n">vtable</span><span class="o">.</span><span class="n">method</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="headers">
<h3>Headers<a class="headerlink" href="#headers" title="Permalink to this heading"></a></h3>
<p>To mimic Java 100% you need the full object header, with the synchronization lock, type of object, etc., a total of 16 bytes.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Modules.html" class="btn btn-neutral float-left" title="Modules" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="PackageManager.html" class="btn btn-neutral float-right" title="Package manager" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2022 Mathnerd314.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>