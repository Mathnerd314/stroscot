<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>As fast as C &mdash; Stroscot  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/hexagon_favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=7f41d439"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Functional logic" href="FunctionalLogic.html" />
    <link rel="prev" title="Exceptions" href="Exceptions.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html">
            
              <img src="../_static/hexagon_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../GettingStarted/index.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HowTo/index.html">How to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/index.html">Language Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Commentary</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Aspects.html">Aspects</a></li>
<li class="toctree-l2"><a class="reference internal" href="Assembly.html">Assembly</a></li>
<li class="toctree-l2"><a class="reference internal" href="BuildSystem.html">Build system</a></li>
<li class="toctree-l2"><a class="reference internal" href="Checklist.html">Checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="Code-Generation.html">Code generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Compiler.html">Compiler design</a></li>
<li class="toctree-l2"><a class="reference internal" href="Compiler-Library.html">Compiler library</a></li>
<li class="toctree-l2"><a class="reference internal" href="CompilerOutput.html">Compiler output</a></li>
<li class="toctree-l2"><a class="reference internal" href="Concurrency.html">Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="CoreSyntax.html">Core syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="Dispatch.html">Dispatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="Errors.html">Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="Evaluation-Strategy.html">Evaluation strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="Exceptions.html">Exceptions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">As fast as C</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#benchmarks">Benchmarks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-programs">C programs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#natural-translations">Natural translations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#asymptotics">Asymptotics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tail-calls">Tail calls</a></li>
<li class="toctree-l3"><a class="reference internal" href="#laziness">Laziness</a></li>
<li class="toctree-l3"><a class="reference internal" href="#avoiding-slow-operations">Avoiding slow operations</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="FunctionalLogic.html">Functional logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="IR.html">Intermediate representation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Learning.html">Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="Logic.html">Logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="LogicProgramming.html">Logic programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="Macros.html">Macros</a></li>
<li class="toctree-l2"><a class="reference internal" href="Memory-Management.html">Memory management</a></li>
<li class="toctree-l2"><a class="reference internal" href="Meta.html">Meta</a></li>
<li class="toctree-l2"><a class="reference internal" href="Modules.html">Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="Objects.html">Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="OpPrims.html">Operational primitives</a></li>
<li class="toctree-l2"><a class="reference internal" href="PackageManager.html">Package manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="Parsing.html">Parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="Posets.html">Posets</a></li>
<li class="toctree-l2"><a class="reference internal" href="Profiling.html">Profiling</a></li>
<li class="toctree-l2"><a class="reference internal" href="Programs.html">Exemplary programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="Reduction.html">Reduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="Reduction-Example.html">Reduction example</a></li>
<li class="toctree-l2"><a class="reference internal" href="Resource-Management.html">Resource management</a></li>
<li class="toctree-l2"><a class="reference internal" href="Security.html">Security</a></li>
<li class="toctree-l2"><a class="reference internal" href="Sets.html">Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="Standard-Library.html">Standard library</a></li>
<li class="toctree-l2"><a class="reference internal" href="State.html">Stateful programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="Symbolic.html">Symbolic computing</a></li>
<li class="toctree-l2"><a class="reference internal" href="Syntax.html">Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="TermRewriting.html">Term rewriting</a></li>
<li class="toctree-l2"><a class="reference internal" href="Time.html">Time API</a></li>
<li class="toctree-l2"><a class="reference internal" href="Tools.html">Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="Types.html">Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="Units.html">Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="Values.html">Values</a></li>
<li class="toctree-l2"><a class="reference internal" href="Verification.html">Verification</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../zzreferences.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Stroscot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Commentary</a></li>
      <li class="breadcrumb-item active">As fast as C</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/Mathnerd314/stroscot/edit/master/docs/Commentary/Fastest.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="as-fast-as-c">
<h1>As fast as C<a class="headerlink" href="#as-fast-as-c" title="Link to this heading"></a></h1>
<p>How do you prove that Stroscot is “as fast as C”? Well, we must show that every C program has a natural Stroscot translation, that performs at least as fast. Since Stroscot is an expressive language there may be many natural translations, and all must perform as fast.</p>
<p>Stroscot should also have fast performance on programs that aren’t natural translations of C programs, but this is secondary to the claim. Even the lambda calculus, after years of study, has no optimal implementation on modern machines. So long as the implementation is reasonable the actual performance on non-C-like programs doesn’t matter - worst-case, the feature becomes a footgun for people are performance sensitive.</p>
<section id="benchmarks">
<h2>Benchmarks<a class="headerlink" href="#benchmarks" title="Link to this heading"></a></h2>
<p>One aspect is benchmarks implemented in both C and Stroscot. This is the approach taken by the programming language shootout. The Stroscot programs could cheat by being “better written” than “naive” C programs, but requiring that they be “natural translations” avoids this.</p>
<p>Controlling the computer hardware and other running processes, we can test the strength of the code generator.</p>
<p>But writing benchmarks is tedious, and my hand-crafted code generator will take a lot of work to beat LLVM.</p>
</section>
<section id="c-programs">
<h2>C programs<a class="headerlink" href="#c-programs" title="Link to this heading"></a></h2>
<p>C programs consist of subroutines, with parameters passed by value. Variables have lexical scope and are stored on the stack. Recursion has no TCO. Subroutines execute a series of instructions, which can be blocks, structured programming constructs (if/else, for, do/while, while, continue/break, switch), function calls, assignments or returns. Instructions contain expressions, which can be arithmetic (<code class="docutils literal notranslate"><span class="pre">*/%+-</span></code>, unary ‘-’ (negation), ‘+’, ‘!’, ‘~’), bitwise (<code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span> <span class="pre">&lt;&lt;</span> <span class="pre">&amp;</span> <span class="pre">^</span> <span class="pre">|</span></code>), or logic operators ( ‘&lt;’ ‘&lt;=’ ‘&gt;’ ‘&gt;=’, ‘==’ ‘!=’, ‘&amp;&amp;’, ‘||’), or pointer reference/dereference. Types include signed/unsigned integer of various sizes, struct, union, pointer. The sizeof function is built-in. Enums are ints and arrays are pointers, so they can be ignored.</p>
</section>
<section id="natural-translations">
<h2>Natural translations<a class="headerlink" href="#natural-translations" title="Link to this heading"></a></h2>
<p>With functional programming the natural translation of a set of loops is a set of mutually recursive functions. To get the same performance as C they need to be tail-recursive (hence translatable to jumps). So we need to mark that these functions should be inlined into the main (C convention) function. Or do the reverse like Haskell and have TCO by default and C convention as marked. So then subroutines translate to functions that do I/O marked with the C calling convention. If we devise a default CC that’s just as fast but allows TCO then the C annotation can be dropped, although it’s still necessary for the FFI.</p>
<p>Naked blocks are just a variable scoping mechanism. The equivalent is <code class="docutils literal notranslate"><span class="pre">let</span></code> or <code class="docutils literal notranslate"><span class="pre">where</span></code>.</p>
<p>if/else and switch are case expressions. Arithmetic and bitwise operations are strict primitive functions. Logic operators are strict too except for &amp;&amp;/|| which are lazy in the second argument. That covers signed/unsigned integers and booleans.</p>
<p>For I/O we use Task + continuation monad. The <code class="docutils literal notranslate"><span class="pre">return</span></code> statement is preserved. C function calls can be embedded as normal.</p>
<p>Variables can be defined/assigned with the <code class="docutils literal notranslate"><span class="pre">ref</span></code>/<code class="docutils literal notranslate"><span class="pre">:=</span></code> imperative operations. But also natural is to use pure values to represent them and add extra function parameters.</p>
<p>structs and unions can be represented as arrays of bytes with read/write operations. The operations can be imperative, or we can provide pure update operations and do Hughes’s optimization to turn them back into destructive updates.</p>
<p>Pointer reference/dereference can be imperative or we could represent memory as an associative array and use pure operations with Hughes’s optimization.</p>
</section>
<section id="asymptotics">
<h2>Asymptotics<a class="headerlink" href="#asymptotics" title="Link to this heading"></a></h2>
<p>A direct mapping works for small programs, but what about large programs? We must ensure that the asymptotic overhead of each of our features is not too large. In particular time and space usage.</p>
<p>Tail-recursive term rewriting compiles into a state machine just like tail-recursive functions.</p>
<p>Laziness can affect space usage. But forcing at each imperative operation should avoid this, it just means the compiler has to propagate demand and see that everything is strict.</p>
<p>Exceptions add some complexity to the control flow, but if you don’t use exception handling then they all turn into panics, which are pretty cheap.</p>
<p>The verification stuff is all at compile time, so it gets cached. So not a big factor.</p>
</section>
<section id="tail-calls">
<h2>Tail calls<a class="headerlink" href="#tail-calls" title="Link to this heading"></a></h2>
<p>Recursive tail calls encode loops. Similarly non-recursive tail calls encode state machines, that can be encoded as a switch-on-enum wrapped in a loop.</p>
<p>In general, caller cleanup is faster, while callee cleanup gives smaller code. The C calling convention uses caller cleanup; the caller pops a fixed number of arguments off the stack after returning from the callee. The C convention lets caller reuse one set of outgoing argument space for all calls.</p>
<p>To perform tail calls in the case in which the callee has more arguments than the
caller, you have to make sure that callees pop all their arguments, i.e. it requires callee cleanup.</p>
<p>The difference is on the order of 20% in practice.</p>
<p>Nobody seems to have benchmarked 64-bit calling conventions. These use more registers so are less sensitive to stack stuff.</p>
<p>Thorin implements lambda mangling which makes basic blocks as fast as C.</p>
</section>
<section id="laziness">
<h2>Laziness<a class="headerlink" href="#laziness" title="Link to this heading"></a></h2>
<p>The overhead of laziness means Haskell often loses to C. Laziness only helps timewise if a box is discarded, and otherwise hurts. And intended laziness is actually quite rare.</p>
<p>So in addition to GHC’s demand analysis which has to prove usage to optimize to strict and falls back to lazy, we want a cost analysis which identifies nontermination and opportunities for saving a lot by discarding and falls back to strict. Also we should evaluate in the case where evaluating directly is cheaper than allocating a thunk (numerical computations and such): <a class="reference external" href="http://blog.ezyang.com/2011/05/anatomy-of-a-thunk-leak/">http://blog.ezyang.com/2011/05/anatomy-of-a-thunk-leak/</a></p>
</section>
<section id="avoiding-slow-operations">
<h2>Avoiding slow operations<a class="headerlink" href="#avoiding-slow-operations" title="Link to this heading"></a></h2>
<p>Another thing that slows down a language are certain kinds of operations. E.g. dynamic lookups, weak typing, variant types. See examples of what makes PHP slow in this <a class="reference external" href="https://www.youtube.com/watch?v=p5S1K60mhQU">video</a>. In some cases you can replace these operations with faster ones (specialization). JIT has more information and can specialize based on the observed values. Profile-guided ahead of time optimization can do the same thing but with the JIT the profiling is built in and you don’t have to do a separate build.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Exceptions.html" class="btn btn-neutral float-left" title="Exceptions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="FunctionalLogic.html" class="btn btn-neutral float-right" title="Functional logic" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2022 Mathnerd314.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>