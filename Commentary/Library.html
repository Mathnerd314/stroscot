<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Library &mdash; Stroscot  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/hexagon_favicon.png"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Logic" href="Logic.html" />
    <link rel="prev" title="Macros" href="Fexprs.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html">
            <img src="../_static/hexagon_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../GettingStarted/index.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HowTo/index.html">How to</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Reference/index.html">Language Reference</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Commentary</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Assembly.html">Assembly</a></li>
<li class="toctree-l2"><a class="reference internal" href="BuildSystem.html">Build system</a></li>
<li class="toctree-l2"><a class="reference internal" href="Code-Generation.html">Code generation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Compiler.html">Compiler design</a></li>
<li class="toctree-l2"><a class="reference internal" href="CoreSyntax.html">Core syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="Evaluation-Strategy.html">Evaluation strategy</a></li>
<li class="toctree-l2"><a class="reference internal" href="Exceptions.html">Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="F2G2_example.html">F2 G2</a></li>
<li class="toctree-l2"><a class="reference internal" href="Fastest.html">As fast as C</a></li>
<li class="toctree-l2"><a class="reference internal" href="Fexprs.html">Macros</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#minimal-definition">Minimal definition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#poison-values">Poison values</a></li>
<li class="toctree-l3"><a class="reference internal" href="#relations">Relations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#posets">Posets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dictionaries">Dictionaries</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generics">Generics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#transactional-memory">Transactional memory</a></li>
<li class="toctree-l3"><a class="reference internal" href="#units">Units</a></li>
<li class="toctree-l3"><a class="reference internal" href="#iterators">Iterators</a></li>
<li class="toctree-l3"><a class="reference internal" href="#work-stealing-task-queues">Work stealing task queues</a></li>
<li class="toctree-l3"><a class="reference internal" href="#properties">Properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="#arrays">Arrays</a></li>
<li class="toctree-l3"><a class="reference internal" href="#evolution">Evolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#equality">Equality</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-structures">Data structures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Logic.html">Logic</a></li>
<li class="toctree-l2"><a class="reference internal" href="Memory-Management.html">Memory management</a></li>
<li class="toctree-l2"><a class="reference internal" href="Meta.html">About</a></li>
<li class="toctree-l2"><a class="reference internal" href="Modules.html">Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="Objects.html">Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="PackageManager.html">Package manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="Programs.html">Exemplary programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="Reduction.html">Reduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="Reduction-Example.html">Reduction example</a></li>
<li class="toctree-l2"><a class="reference internal" href="Sets.html">Sets</a></li>
<li class="toctree-l2"><a class="reference internal" href="State.html">Imperative programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="Syntax.html">Syntax</a></li>
<li class="toctree-l2"><a class="reference internal" href="TermRewriting.html">Term rewriting</a></li>
<li class="toctree-l2"><a class="reference internal" href="Verification.html">Verification</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../zzreferences.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Stroscot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Commentary</a> &raquo;</li>
      <li>Library</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/Mathnerd314/stroscot/edit/master/docs/Commentary/Library.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="library">
<h1>Library<a class="headerlink" href="#library" title="Permalink to this headline"></a></h1>
<section id="minimal-definition">
<h2>Minimal definition<a class="headerlink" href="#minimal-definition" title="Permalink to this headline"></a></h2>
<p>At a minimum, the standard library should provide:
* containers, such as hash maps and binary trees
* algorithms operating over those containers, such as sorting
* basic support for multithreading
* string tokenization
* compiler’s API</p>
</section>
<section id="poison-values">
<h2>Poison values<a class="headerlink" href="#poison-values" title="Permalink to this headline"></a></h2>
<p>This requires some support from the OS to implement. Pointer reads generate page faults, which if they are invalid will be returned to the program via the signal “Segmentation fault” (SIGSEGV). C/C++ <a class="reference external" href="https://stackoverflow.com/questions/2350489/how-to-catch-segmentation-fault-in-linux">can’t handle these easily</a> because they are <a class="reference external" href="https://lwn.net/Articles/414618/">synchronous signals</a> and synchronous signal behavior is mostly left undefined, but in fact signals are <a class="reference external" href="https://hackaday.com/2018/11/21/creating-black-holes-division-by-zero-in-practice/">fairly well-behaved</a> (<a class="reference external" href="https://sources.debian.org/src/openssl/1.1.1k-1/crypto/s390xcap.c/?hl=48#L48">OpenSSL</a>’s method of recovering from faults even seems standards-compliant). It definitely seems possible to implement this as an error value in a new language. Go <a class="reference external" href="https://stackoverflow.com/questions/43212593/handling-sigsegv-with-recover">allows</a> turning (synchronous) signals into “panics” that can be caught with recover.</p>
<p>UDIV by 0 on ARM simply produces 0. So on ARM producing the division by 0 error requires checking if the argument is zero beforehand and branching. The people that really can’t afford this check will have to use the unchecked division instruction in the assembly module, or make sure that the check is compiled out. But on x86, DIV by 0 on produces a fault, which on Linux the kernel picks up and sends to the application as a SIGFPE. So on x86 we can decide between inserting a check and handling the SIGFPE. It’ll require testing to see which is faster in typical programs - my guess is the handler, since division by zero is rare.</p>
</section>
<section id="relations">
<h2>Relations<a class="headerlink" href="#relations" title="Permalink to this headline"></a></h2>
<p>There are various types of relations: <a class="reference external" href="https://en.wikipedia.org/wiki/Binary_relation#Special_types_of_binary_relations">https://en.wikipedia.org/wiki/Binary_relation#Special_types_of_binary_relations</a></p>
<p>The question is, what data types do we need for relations?</p>
<ul class="simple">
<li><p>Function: we need functions, obviously.</p></li>
<li><p>Functional: This is a function too, just add a “no clause defined” element.</p></li>
<li><p>One-to-one: a function with an assertion, <code class="docutils literal notranslate"><span class="pre">assume(forall</span> <span class="pre">x</span> <span class="pre">y;</span> <span class="pre">if</span> <span class="pre">f</span> <span class="pre">x</span> <span class="pre">==</span> <span class="pre">f</span> <span class="pre">y</span> <span class="pre">{</span> <span class="pre">assert</span> <span class="pre">x</span> <span class="pre">==</span> <span class="pre">y}</span></code></p></li>
<li><p>Many-to-one: A function, no constraints</p></li>
<li><p>Injective: This is the converse of a function, just use the function.</p></li>
<li><p>One-to-many: the converse of a function, again just use the function.</p></li>
</ul>
<p>So the only relation that can’t be represented by a one-argument function is a many-to-many relation. Here we really do have a set of tuples. There are choices of how to implement this set.</p>
<p>We could use a function of two arguments returning a boolean, if the domain/codomain are infinite. Or if both domain and codomain are finite, a set data structure containing tuples. Or a boolean matrix, if there are lots of tuples. Or a map of sets if one of the elements is sparse. Or a directed simple graph if we have a graph library.</p>
<p>Then we have the reflexive, symmetric, transitive closures for many-to-many relations. With a finite relation these are straightforward to compute via matrix algorithms or their equivalent. For infinite sets we have to work harder and use some form of symbolic reasoning.</p>
</section>
<section id="posets">
<h2>Posets<a class="headerlink" href="#posets" title="Permalink to this headline"></a></h2>
<p>Q: Can ~ be preferred if there is ambiguity? E.g. 1 &lt;~ 2 resolving to 1 ~ 2. Is it safe under extension?</p>
</section>
<section id="dictionaries">
<h2>Dictionaries<a class="headerlink" href="#dictionaries" title="Permalink to this headline"></a></h2>
<p>Wikipedia calls these “associative arrays” and C++ and Haskell calls them maps. But dictionary seems to be the accepted term in the data structure textbooks, and it’s about the right length as a word.</p>
</section>
<section id="generics">
<h2>Generics<a class="headerlink" href="#generics" title="Permalink to this headline"></a></h2>
<p>Since Stroscot is dynamic the default is heterogeneous collections that can contain anything. So for example you have a clause <code class="docutils literal notranslate"><span class="pre">cons</span> <span class="pre">:</span> <span class="pre">Any</span> <span class="pre">-&gt;</span> <span class="pre">List</span> <span class="pre">-&gt;</span> <span class="pre">List</span></code>. Nonetheless collections have “types”, namely the set of elements of the collection. So the example in section of 9.1.1 of <span id="id1">[<a class="reference internal" href="../zzreferences.html#id25" title="Stephen Dolan. Algebraic Subtyping. PhD thesis, University of Cambridge, September 2016. URL: https://www.cs.tufts.edu/~nr/cs257/archive/stephen-dolan/thesis.pdf.">Dol16</a>]</span> might be written as follows:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">contents</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="n">elementOf</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="kt">TypedList</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">contents</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="n">subset</span><span class="w"> </span><span class="n">t</span><span class="p">}</span><span class="w"></span>

<span class="nf">singleton</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Any</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">TypedList</span><span class="w"> </span><span class="p">{</span><span class="n">a</span><span class="p">}</span><span class="w"></span>
<span class="nf">singleton</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"></span>

<span class="nf">get</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">TypedList</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Op</span><span class="w"> </span><span class="n">x</span><span class="w"></span>
<span class="nf">put</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">List</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Any</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"></span>

<span class="kt">Component</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Button</span><span class="o">|</span><span class="kt">Checkbox</span><span class="w"></span>

<span class="nf">disable</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Component</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"></span>
<span class="nf">disable</span><span class="w"> </span><span class="kt">Button</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">print</span><span class="w"> </span><span class="s">&quot;Button disabled&quot;</span><span class="w"></span>
<span class="nf">disable</span><span class="w"> </span><span class="kt">Checkbox</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">print</span><span class="w"> </span><span class="s">&quot;Checkbox disabled&quot;</span><span class="w"></span>

<span class="nf">disableAll</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">TypedList</span><span class="w"> </span><span class="kt">Component</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"></span>
<span class="nf">disableAll</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">mapM</span><span class="w"> </span><span class="n">disable</span><span class="w"> </span><span class="n">l</span><span class="w"></span>

<span class="nf">buttons</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="kt">Button</span><span class="p">]</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="kt">Button</span><span class="w"></span>
<span class="nf">components</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="kt">Button</span><span class="p">,</span><span class="kt">Checkbox</span><span class="p">]</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">TypedList</span><span class="w"> </span><span class="kt">Component</span><span class="w"></span>
<span class="nf">assert</span><span class="w"> </span><span class="p">(</span><span class="n">not</span><span class="w"> </span><span class="p">(</span><span class="n">component</span><span class="w"> </span><span class="n">isElemOf</span><span class="w"> </span><span class="kt">TypedList</span><span class="w"> </span><span class="kt">Button</span><span class="p">))</span><span class="w"></span>

<span class="nf">disableAll</span><span class="w"> </span><span class="n">buttons</span><span class="w"></span>
<span class="nf">disableAll</span><span class="w"> </span><span class="n">components</span><span class="w"></span>

<span class="nf">insertCheckbox</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">List</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"></span>
<span class="nf">insertCheckbox</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">append</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="kt">Checkbox</span><span class="w"></span>
<span class="nf">disableAllAndAddCheckbox</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">TypedList</span><span class="w"> </span><span class="kt">Component</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"></span>
<span class="nf">disableAllAndAddCheckbox</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">disableAll</span><span class="w"> </span><span class="n">l</span><span class="p">;</span><span class="w"> </span><span class="n">insertCheckbox</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="p">}</span><span class="w"></span>

<span class="nf">disableAllAndAddCheckbox</span><span class="w"> </span><span class="n">buttons</span><span class="w"></span>
<span class="nf">assert</span><span class="w"> </span><span class="p">(</span><span class="n">not</span><span class="w"> </span><span class="p">(</span><span class="n">buttons</span><span class="w"> </span><span class="n">isElemOf</span><span class="w"> </span><span class="kt">TypedList</span><span class="w"> </span><span class="kt">Button</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<p>It seems quite sufficient, because Stroscot finds assertion failures at compile time. But maybe the static typing people want more. In particular we want to specify a write bound, limiting the types of elements that may be added. So we define restricted lists:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">singleton</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Set</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">RestrictedList</span><span class="w"></span>
<span class="nf">put</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">RestrictedList</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">elemType</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Cmd</span><span class="w"></span>
</pre></div>
</div>
<p>All it does is give errors earlier though - the errors show up regardless once you try to use an element of the wrong type. So maybe it’s not needed.</p>
</section>
<section id="transactional-memory">
<h2>Transactional memory<a class="headerlink" href="#transactional-memory" title="Permalink to this headline"></a></h2>
<p>STM is a very attractive abstraction for beginners or those who can sacrifice some performance to ensure correctness. But the performance in benchmarks is so-so and when it’s really slow the implementation is somewhat complex to optimize. So STM hasn’t seen much success in high-performance areas. The main primitives have to be the OS mutexes and atomic instructions. But still, providing STM as a library would be good. Haskell has STM, Fortress worked on STM. It automates the programming pattern of “read struct pointer, read members, allocate new structure, compare-and-swap struct pointer” which is really common for high-performance concurrency.</p>
<p>The syntax is a simple DSL, <code class="docutils literal notranslate"><span class="pre">atomically</span> <span class="pre">{</span> <span class="pre">if</span> <span class="pre">x</span> <span class="pre">{</span> <span class="pre">retry</span> <span class="pre">};</span> <span class="pre">y</span> <span class="pre">:=</span> <span class="pre">z</span> <span class="pre">}</span></code>. Transactions nested inside another transaction are elided, so that one big transaction forms. The semantics is a transaction has a visible effect (commits its writes) only if all state read during the transaction is not modified by another thread. The <code class="docutils literal notranslate"><span class="pre">retry</span></code> command blocks the transaction until the read state has changed, then starts it over, in an endless loop until a path avoiding the <code class="docutils literal notranslate"><span class="pre">retry</span></code> is taken. The implementation should guarantee eventual fairness: A transaction will be committed eventually, provided it doesn’t retry all the time. The latest research seems to be <span id="id2">[<a class="reference internal" href="../zzreferences.html#id81" title="Pedro Ramalhete, Andreia Correia, and Pascal Felber. Efficient algorithms for persistent transactional memory. In Proceedings of the 26th ACM SIGPLAN Symposium on Principles and Practice of Parallel Programming, PPoPP '21, 1–15. New York, NY, USA, February 2021. Association for Computing Machinery. URL: https://doi.org/10.1145/3437801.3441586 (visited on 2021-11-11), doi:10.1145/3437801.3441586.">RCF21</a>]</span>, it might be usable. Have to extend it to handle transaction retries though.</p>
<p>Transactions have sequentially consistent semantics by default. But mixing transactions with low-level code might work, IDK. There could be <code class="docutils literal notranslate"><span class="pre">atomically</span> <span class="pre">{order=relaxed}</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code> to use the CPU’s memory model instead of totally ordered. The transaction syntax is more expressive than atomic instructions, so providing an atomic DSL would be nice. I.e. transactions matching atomic instructions should compile to the atomic instructions, plus thread wakeups but only if there are waiting threads with <code class="docutils literal notranslate"><span class="pre">retry</span></code> involved.</p>
</section>
<section id="units">
<h2>Units<a class="headerlink" href="#units" title="Permalink to this headline"></a></h2>
<p>Code with units will probably never be the default, but numeric types with dimensional units are useful for safety. The main issue is performance - checking/converting units on every operation is slow. But I tried using some Python unit libraries and they were OK for scripting purposes. Inlining should work for compiled code. Syntax is an issue, handling exponents and other dimensionless operations is an issue.</p>
</section>
<section id="iterators">
<h2>Iterators<a class="headerlink" href="#iterators" title="Permalink to this headline"></a></h2>
<p>Haskell has <code class="docutils literal notranslate"><span class="pre">Foldable</span></code>, the main function being <code class="docutils literal notranslate"><span class="pre">foldr</span> <span class="pre">:</span> <span class="pre">(a</span> <span class="pre">-&gt;</span> <span class="pre">b</span> <span class="pre">-&gt;</span> <span class="pre">b)</span> <span class="pre">-&gt;</span> <span class="pre">b</span> <span class="pre">-&gt;</span> <span class="pre">t</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">b</span></code>, which is equivalently <code class="docutils literal notranslate"><span class="pre">t</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">(a</span> <span class="pre">-&gt;</span> <span class="pre">b</span> <span class="pre">-&gt;</span> <span class="pre">b)</span> <span class="pre">-&gt;</span> <span class="pre">b</span> <span class="pre">-&gt;</span> <span class="pre">b</span></code>, the latter part being the <a class="reference external" href="https://okmij.org/ftp/tagless-final/course/Boehm-Berarducci.html">Boehm-Berarducci encoding</a> of <code class="docutils literal notranslate"><span class="pre">[a]</span></code>. So really <code class="docutils literal notranslate"><span class="pre">Foldable</span> <span class="pre">t</span></code> is just a function <code class="docutils literal notranslate"><span class="pre">toList</span> <span class="pre">:</span> <span class="pre">t</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">[a]</span></code>. <code class="docutils literal notranslate"><span class="pre">foldMap</span></code> has a more general type that would allow a parallel fold, but in Haskell it’s is required to be right-associative. So Haskell <code class="docutils literal notranslate"><span class="pre">Foldable</span></code> is strictly a linked list with <code class="docutils literal notranslate"><span class="pre">foldr</span></code> applied. We might as well call the class <code class="docutils literal notranslate"><span class="pre">ListLike</span></code>.</p>
<p><a class="reference external" href="https://homes.luddy.indiana.edu/samth/fortress-spec.pdf#page=128">Fortress</a> has real parallel folds similar to <code class="docutils literal notranslate"><span class="pre">foldMap</span></code>. They have “reductions” which are just monoids, and then a “generator” is <code class="docutils literal notranslate"><span class="pre">generate</span> <span class="pre">:</span> <span class="pre">(Monoid</span> <span class="pre">r)</span> <span class="pre">=&gt;</span> <span class="pre">Generator</span> <span class="pre">e</span> <span class="pre">-&gt;</span> <span class="pre">(e</span> <span class="pre">-&gt;</span> <span class="pre">r)</span> <span class="pre">-&gt;</span> <span class="pre">r</span></code>. The monoid does not have to be commutative - results are combined in the natural order of the generator. Empty elements may be inserted freely by <code class="docutils literal notranslate"><span class="pre">generate</span></code>. The implementation is based on recursive subdivision to divide a blocked range into approximately equal-sized chunks of work.</p>
<p>They also have generator comprehensions and big operator syntax, but the description is confusing.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">impure_list</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Set</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Nil</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">Cons</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kr">data</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Item</span><span class="p">,</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kt">Op</span><span class="w"> </span><span class="p">(</span><span class="n">impure_list</span><span class="w"> </span><span class="kt">Item</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="nf">getIterator</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Op</span><span class="w"> </span><span class="p">(</span><span class="n">impure_list</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"></span>
<span class="nf">getIterator</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">go</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>
<span class="w">  </span><span class="n">go</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="n">arr</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">return</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Cons</span><span class="w"> </span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="p">(</span><span class="n">go</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">arr</span><span class="p">)</span><span class="w"></span>
<span class="w">           </span><span class="o">|</span><span class="w"> </span><span class="n">otherwise</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">return</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Nil</span><span class="w"></span>
</pre></div>
</div>
<p>The problem with this design is you can accidentally store the <code class="docutils literal notranslate"><span class="pre">next</span></code> operation and re-use it. With <code class="docutils literal notranslate"><span class="pre">next</span> <span class="pre">:</span> <span class="pre">Iterator</span> <span class="pre">-&gt;</span> <span class="pre">Op</span> <span class="pre">(Done</span> <span class="pre">|</span> <span class="pre">Yield</span> <span class="pre">a)</span></code> the similar pattern <code class="docutils literal notranslate"><span class="pre">let</span> <span class="pre">y</span> <span class="pre">=</span> <span class="pre">next</span> <span class="pre">iter</span> <span class="pre">in</span> <span class="pre">{</span> <span class="pre">y;</span> <span class="pre">y}</span></code> just results in calling <code class="docutils literal notranslate"><span class="pre">next</span></code> twice and does not corrupt the iterator state.</p>
</section>
<section id="work-stealing-task-queues">
<h2>Work stealing task queues<a class="headerlink" href="#work-stealing-task-queues" title="Permalink to this headline"></a></h2>
<p>Java has them, C++ has OpenMPI and libuv. Many other languages have a library for them as well. So Stroscot should too.</p>
</section>
<section id="properties">
<h2>Properties<a class="headerlink" href="#properties" title="Permalink to this headline"></a></h2>
<p>Partial orders are good, no reason not to have them. The orders defined with posets should be usable dynamically. Similarly they should be in a set <code class="docutils literal notranslate"><span class="pre">TotalOrder</span></code> if appropriate. Similarly <code class="docutils literal notranslate"><span class="pre">Commutative</span></code>, <code class="docutils literal notranslate"><span class="pre">Associative</span></code> for binary operators.</p>
</section>
<section id="arrays">
<h2>Arrays<a class="headerlink" href="#arrays" title="Permalink to this headline"></a></h2>
<p>In Stroscot the only mutable thing is a reference. So mutable arrays could mean two things: a fixed-size immutable array containing mutable values, or a mutable variable storing an immutable array. The second seems more similar to Java’s ArrayList or C++ std::vector so is probably what is meant.</p>
<p>The key here for efficient performance is in-place (destructive) update, so that the array re-uses its storage instead of copying on every operation. There is a paper <span id="id3">[<a class="reference internal" href="../zzreferences.html#id48" title="Paul Hudak and Adrienne Bloss. The aggregate update problem in functional programming systems. In Proceedings of the 12th ACM SIGACT-SIGPLAN Symposium on Principles of Programming Languages - POPL '85, 300–314. New Orleans, Louisiana, United States, 1985. ACM Press. URL: http://portal.acm.org/citation.cfm?doid=318593.318660 (visited on 2022-01-04), doi:10.1145/318593.318660.">HB85</a>]</span> on how to do it for lazy programming - basically you perform reads eagerly, and delay array update operations as long as possible, until it is clear if you can do in-place update or will have to copy.</p>
</section>
<section id="evolution">
<h2>Evolution<a class="headerlink" href="#evolution" title="Permalink to this headline"></a></h2>
<p>If the standard library is missing something, different incompatible implementations may arise. Sharing code then becomes problematic, because code is tied to one of these implementations. The need then arises for a wrapper library that smooths over the differences and provides a portable interface.</p>
<p>Generally something should only be in the standard library once it’s reached this “portable interface” level, or if it’s been a while and only one implementation has emerged. But otherwise, there are often 2-3 good alternatives that people need to choose from. So there should also be a “non-standard libraries” wiki or something listing alternatives and even providing comparison tables with pros/cons if people feel like writing it.</p>
</section>
<section id="equality">
<h2>Equality<a class="headerlink" href="#equality" title="Permalink to this headline"></a></h2>
<p>Equality is an equivalence relation <code class="docutils literal notranslate"><span class="pre">(==)</span> <span class="pre">:</span> <span class="pre">Any</span> <span class="pre">-&gt;</span> <span class="pre">Any</span> <span class="pre">-&gt;</span> <span class="pre">Bool</span></code> built in to Stroscot. Or maybe it is <code class="docutils literal notranslate"><span class="pre">:</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">Bool</span></code> and only defined on certain types. The built-in approach seems more attractive.</p>
<p>For ordering though, <code class="docutils literal notranslate"><span class="pre">(&lt;=)</span> <span class="pre">:</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">a</span> <span class="pre">-&gt;</span> <span class="pre">{LT,GT,EQ}</span></code> seems the way to go. Many types do not have a reasonable ordering.</p>
<dl class="simple">
<dt>value representation:</dt><dd><p>Nanboxing / nunboxing</p>
</dd>
</dl>
</section>
<section id="data-structures">
<h2>Data structures<a class="headerlink" href="#data-structures" title="Permalink to this headline"></a></h2>
<p>Copy Python’s, they’ve been optimized and should be as efficient as anything I’ll write.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Fexprs.html" class="btn btn-neutral float-left" title="Macros" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Logic.html" class="btn btn-neutral float-right" title="Logic" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2020 Mathnerd314.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>