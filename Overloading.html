

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Overloading &mdash; Stroscot  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3.0.1/es5/tex-mml-chtml.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Verification" href="Verification.html" />
    <link rel="prev" title="Syntax" href="Syntax.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Stroscot
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Syntax.html">Syntax</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Overloading</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#semantics">Semantics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sequential-matches">Sequential matches</a></li>
<li class="toctree-l2"><a class="reference internal" href="#method-qualifiers">Method qualifiers</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementation">Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#patterns">Patterns</a></li>
<li class="toctree-l2"><a class="reference internal" href="#overrides">Overrides</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implicit-conversion">Implicit conversion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Verification.html">Verification</a></li>
<li class="toctree-l1"><a class="reference internal" href="Arguments.html">Argument passing</a></li>
<li class="toctree-l1"><a class="reference internal" href="Delimited-Continuations.html">Delimited continuations</a></li>
<li class="toctree-l1"><a class="reference internal" href="Fexprs.html">Metaprogramming</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reduction.html">Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reduction.html#random-old-junk">Random old junk</a></li>
<li class="toctree-l1"><a class="reference internal" href="Reduction-Example.html">Reduction example</a></li>
<li class="toctree-l1"><a class="reference internal" href="Types.html">Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="Modules.html">Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="Memory.html">Memory management</a></li>
<li class="toctree-l1"><a class="reference internal" href="Compiler.html">Compiler design</a></li>
<li class="toctree-l1"><a class="reference internal" href="BuildSystem.html">Build system</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="zzreferences.html">References</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Stroscot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Overloading</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/Mathnerd314/stroscot/edit/master/docs/Overloading.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="overloading">
<h1>Overloading<a class="headerlink" href="#overloading" title="Permalink to this headline">¶</a></h1>
<p>Stroscot supports typical pattern matching as well as predicate dispatch:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">f</span> <span class="mi">1</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">f</span> <span class="n">x</span> <span class="mi">2</span> <span class="o">|</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<p>The cases are not ordered. If multiple predicates match, it is required that all matching cases produce the same result. For example if we were to modify the last case:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">f</span> <span class="mi">1</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">f</span> <span class="n">x</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">3</span>

<span class="n">f</span> <span class="mi">1</span> <span class="mi">2</span>
<span class="c1"># Error: rule conflict</span>
</pre></div>
</div>
<p>But <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">x</span> <span class="pre">2</span> <span class="pre">=</span> <span class="pre">2</span></code> would be allowed. This behavior is useful for creating optimized methods for specific types, and also for tests:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fib</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fib</span> <span class="mi">0</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">fib</span> <span class="n">n</span> <span class="o">=</span> <span class="n">fib</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fib</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># test</span>
<span class="n">fib</span> <span class="mi">5</span> <span class="o">=</span> <span class="mi">5</span>
</pre></div>
</div>
<div class="section" id="semantics">
<h2>Semantics<a class="headerlink" href="#semantics" title="Permalink to this headline">¶</a></h2>
<p>The exact semantics is that all cases are run in parallel using the <a class="reference external" href="http://conal.net/blog/posts/merging-partial-values">lub operation</a> (or maybe its less powerful cousin <code class="docutils literal notranslate"><span class="pre">unamb</span></code>). The <code class="docutils literal notranslate"><span class="pre">lub</span></code> operation is implemented as a primitive that desugars in the middle of compilation, in a deterministic manner based on termination checking. Predicate failure, failed assertions, and nontermination are all treated as bottom.</p>
<p>In fact the semantics is even more complicated, because return values that are not accepted by the surrounding context are also discarded. This falls out naturally from doing the analysis on the CPS-transformed version of the program.</p>
</div>
<div class="section" id="sequential-matches">
<h2>Sequential matches<a class="headerlink" href="#sequential-matches" title="Permalink to this headline">¶</a></h2>
<p>The pipe syntax matches cases from top to bottom:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span>
<span class="o">|</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span>
<span class="o">|</span> <span class="mi">1</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
<span class="o">|</span> <span class="n">x</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<p>It expands to an unordered set of matches:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">|</span> <span class="n">p1</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">f</span> <span class="o">|</span> <span class="n">p2</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">=</span> <span class="o">...</span>
<span class="n">f</span> <span class="o">|</span> <span class="n">p3</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span> <span class="o">=</span> <span class="o">...</span>

<span class="c1"># p1, p2, etc. functions of $args</span>
</pre></div>
</div>
<p>Maybe you will also be able to use <code class="docutils literal notranslate"><span class="pre">match</span></code> within a function, if the syntax details work out:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">match</span> <span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
                      <span class="o">|</span> <span class="mi">1</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="section" id="method-qualifiers">
<h2>Method qualifiers<a class="headerlink" href="#method-qualifiers" title="Permalink to this headline">¶</a></h2>
<p>Stroscot also supports Common Lisp’s method qualifiers: <code class="docutils literal notranslate"><span class="pre">before</span></code>, <code class="docutils literal notranslate"><span class="pre">after</span></code>, and``around`` (<a class="reference external" href="https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Method-combination.png">illustration</a>). Although the dispatch algorithm is complex, the idea is that it is so generic that including it once in the language proper will save everyone’s time by avoiding the need to reimplement it.</p>
<p>Compared to CLOS, it is simplified in that only <code class="docutils literal notranslate"><span class="pre">around</span></code> s can call their next methods; primaries are not ordered by specificity. Also, there is no reference to classes. Specificity is defined by an SMT solver: <code class="docutils literal notranslate"><span class="pre">a</span></code> is less specific than <code class="docutils literal notranslate"><span class="pre">b</span></code> if <code class="docutils literal notranslate"><span class="pre">SAT(a</span> <span class="pre">&amp;</span> <span class="pre">not</span> <span class="pre">b)</span></code> and <code class="docutils literal notranslate"><span class="pre">UNSAT</span> <span class="pre">(not</span> <span class="pre">a</span> <span class="pre">&amp;</span> <span class="pre">b)</span></code>. This is used to group the methods with a topological sort. To make the sort unique we put recently-defined methods first if possible.</p>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>The implementation is similar to that used for checking equality of dependent types, i.e. it does a lot of normalization but isn’t omniscient. The optimizer decides which case is dead code and will be dropped. The full dispatch mechanism is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>dispatch methods args = do
  [arounds, befores, afters, primaries] = map topological_sort $ partition methods
  next-method = DispatchError
  f arounds
  f = \x -&gt;
   case x of
      a:as -&gt; call a { next-method = f as }
      [] -&gt; g
  g = case primaries of
    [] -&gt; DispatchError
    _ -&gt;
      map call befores
      x = call (concat primaries)
      map call (reverse afters)
      return x

call binds args = fold lub DispatchError (map ($ args) binds)
</pre></div>
</div>
<p>The last method qualifier is <code class="docutils literal notranslate"><span class="pre">list</span></code>. This exposes the topological sort dispatch mechanism directly and simply produces the sorted list of lists of applicable methods, that can then be applied or manipulated as needed. It is an error to define a list method if there are any other types of methods (primary, before, after, or around).</p>
</div>
<div class="section" id="patterns">
<h2>Patterns<a class="headerlink" href="#patterns" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="c1"># matches anything</span>
<span class="n">a</span> <span class="c1"># matches anything and binds a</span>
<span class="o">^</span><span class="n">a</span> <span class="c1"># matches the atom a</span>
<span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">}]</span> <span class="c1"># literal matching itself</span>
<span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="c1"># matches any list starting with 1</span>
<span class="p">{</span><span class="n">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="o">...</span><span class="p">:</span> <span class="n">rest</span><span class="p">}</span> <span class="c1"># matches a and the rest of the record</span>
<span class="n">pat</span> <span class="n">AND</span> <span class="n">pat</span> <span class="c1"># matches both patterns simultaneously</span>
<span class="n">pat</span> <span class="n">OR</span> <span class="n">pat</span> <span class="c1"># matches either pattern</span>
<span class="o">~</span><span class="n">pat</span> <span class="c1"># desugars to u_ = let pat = u_ in ..., where u_ is a unique name</span>
</pre></div>
</div>
<p>Guards allow arbitrary functions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="k">with</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span>
</pre></div>
</div>
<p>View patterns</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">f</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
<p>Functions patterns</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Int</span> <span class="n">z</span> <span class="o">=</span> <span class="n">toInteger</span> <span class="n">z</span>

<span class="n">Int</span> <span class="n">a</span>
</pre></div>
</div>
<p>Pattern synonyms</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pattern</span> <span class="n">F</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;f&quot;</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
</pre></div>
</div>
<p>Arbitrary patterns</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_f</span> <span class="n">a</span> <span class="c1"># matches any function application</span>
</pre></div>
</div>
</div>
<div class="section" id="overrides">
<h2>Overrides<a class="headerlink" href="#overrides" title="Permalink to this headline">¶</a></h2>
<p>By default, methods are scoped to their module. Every definition <code class="docutils literal notranslate"><span class="pre">foo</span> <span class="pre">=</span> <span class="pre">a</span></code> binds the identifier <code class="docutils literal notranslate"><span class="pre">Module.foo</span></code>, and each module creates a new identifier. The <code class="docutils literal notranslate"><span class="pre">override</span></code> statement prevents creating a new identifier, so that instead a base identifer can be extended.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># module 1</span>
<span class="n">foo</span> <span class="mi">1</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># module 2</span>
<span class="kn">import</span> <span class="mi">1</span>
<span class="n">override</span> <span class="n">foo</span>
<span class="n">foo</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">3</span>

<span class="c1"># module 3</span>
<span class="kn">import</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span>
<span class="n">foo</span> <span class="mi">1</span> <span class="c1"># 1</span>
<span class="n">foo</span> <span class="mi">2</span> <span class="c1"># 3</span>
</pre></div>
</div>
<p>If the override statement was not in module 2, then using <code class="docutils literal notranslate"><span class="pre">foo</span></code> in module 3 would result in an ambiguous name resolution error.</p>
</div>
<div class="section" id="implicit-conversion">
<h2>Implicit conversion<a class="headerlink" href="#implicit-conversion" title="Permalink to this headline">¶</a></h2>
<p>There is a function <code class="docutils literal notranslate"><span class="pre">convert</span></code> in the core library. It includes as cases / requirements:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">convert</span> <span class="pre">a</span> <span class="pre">=</span> <span class="pre">a</span></code> (reflexivity)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">convert</span> <span class="pre">a</span> <span class="pre">=</span> <span class="pre">convert</span> <span class="pre">(convert</span> <span class="pre">a))</span></code> (transitivity)</p></li>
</ul>
<p>A pass early in compilation adds a call to <code class="docutils literal notranslate"><span class="pre">convert</span></code> around every value, e.g. <code class="docutils literal notranslate"><span class="pre">1+2</span></code> becomes <code class="docutils literal notranslate"><span class="pre">convert</span> <span class="pre">(convert</span> <span class="pre">(+)</span> <span class="pre">(convert</span> <span class="pre">1)</span> <span class="pre">(convert</span> <span class="pre">2)</span></code>.</p>
<p>New cases can be added; this is useful in various instances. For example we can create subtyping.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Verification.html" class="btn btn-neutral float-right" title="Verification" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Syntax.html" class="btn btn-neutral float-left" title="Syntax" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019-2020 Mathnerd314

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>